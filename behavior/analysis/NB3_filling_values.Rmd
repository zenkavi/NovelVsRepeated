---
title: "Novel vs. repeated choice project: Understanding how fillings are created for experimental stimuli"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: 'hide'
---

```{r include=FALSE}
library(tidyverse)
library(janitor)
library(here)
library(magick)
theme_set(theme_bw())
helpers_path = paste0(here(),'/analysis/helpers/')
source(paste0(helpers_path, '01_clean_behavioral_data.R'))
```


Matlab code from `task_YN.m` that determines the filling value for each stimulus

```
bothCol = [0.1 0.1 0.4 -99;
            0.4 0.1 0.1 -99]; 

if  mydata.filling(indextrial)>=0
    colorStim = bothCol(1,:);
    switch  abs(mydata.filling(indextrial))
        case 0.4
            colorStim(3)= 0.6;
        case 0.6
            colorStim(3)= 0.5;
        case 0.85
            colorStim(3)= 0.3;
    end   
else
    colorStim = bothCol(2,:);
    switch  abs(mydata.filling(indextrial))
        case 0.4
            colorStim(1)= 0.6;
        case 0.6
            colorStim(1)= 0.5;
        case 0.85
            colorStim(1)= 0.3;
    end
end
colorStim(4)=abs(mydata.filling(indextrial));
```

Helper functions to create stimuli

```{r}
convertFVToHEX = function(fillingVal){
  
  bothCol = matrix(data = c(.1 , .1, .4, -99, .4, .1, .1, -99), byrow=T, nrow=2, ncol=4)
  
  if(fillingVal>=0){
    colorStim = bothCol[1,]
    colorStim[3] = ifelse(abs(fillingVal)==.4, .6, ifelse(abs(fillingVal)==.6,.5, ifelse(abs(fillingVal)==.85, .3, colorStim[3])))
    
  } else{
    colorStim = bothCol[2,]
    colorStim[1] = ifelse(abs(fillingVal)==.4, .6, ifelse(abs(fillingVal)==.6,.5, ifelse(abs(fillingVal)==.85, .3, colorStim[1])))
  }
  
  colorStim[4] = abs(fillingVal)
  
  hex_code = rgb(colorStim[1], colorStim[2], colorStim[3], colorStim[4])
  

  return(hex_code)
}

make_stim_img = function(shape, orientation, filling){
  
  bg_hex = convertFVToHEX(filling)
  
  # Read image
  shape_img = image_read(paste0('/Users/zeynepenkavi/Downloads/alldata/data_task/pilot5_fmri_1/task_scan/shapes/shape', shape, '.png'))
  
  tilted_filled_img = shape_img %>% 
    image_background(bg_hex) %>%
    image_rotate(orientation)
  
  tilted_filled_img = image_read(image_write(tilted_filled_img))
  
  return(tilted_filled_img)
  
}
```

```{r}
dat = data.frame(filling = unique(data_yn_clean$filling))

for(i in 1:nrow(dat)){
  dat$hex_code[i] = convertFVToHEX(dat$filling[i])
}

dat = dat %>%
  arrange(filling)

dat
```

```{r}
ggplot()+
  annotate("rect", xmin=c(1,2,3,1,2,3,1,2,3), xmax=c(2,3,4,2,3,4,2,3,4), ymin=c(1,1,1,2,2,2,3,3,3) , ymax=c(2,2,2,3,3,3,4,4,4), fill=c(dat$hex_code))+
  annotate("text", x=c(1,2,3,1,2,3,1,2,3)+.5, y=c(1,1,1,2,2,2,3,3,3)+.5 , label=c(dat$filling))+
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        panel.border = element_blank())
```

The stimuli are not gambles. If they are chosen to be played they always yield the same reward. If they are not chosen then they yield the reference amount.

```{r}
tmp = data_yn_clean %>%
  filter(yesChosen == 1) %>%
  select(possiblePayoff, payoff)

sum(tmp$possiblePayoff == tmp$payoff) == nrow(tmp)
```

*BUT* the payoff for each stimulus is sampled from a distribution

```{r}
data_yn_clean %>%
  filter(subnum == "601") %>%
  filter(stimNum == 85) %>%
  tabyl(possiblePayoff)
```

How many HT and RE trials in each session?

```{r}
with(data_yn_clean, table(type, day, subnum))
```

```{r}
with(data_bc_clean, table(typeLeft, day, fmri, subnum))
```

3 features: 
Shape 6
Orientation 11
Filling 11

Does the orientation and filling have the same value for each shape? Yes.

```{r}
dat = data_yn_clean %>%
  filter(subnum == 601) %>%
  select(subnum, day, stimNum, type, orientation, filling, shape, valueO, valueF, valueS, possiblePayoff)
```


```{r}
with(dat, table(orientation, valueO, shape))
```

```{r}
with(dat, table(filling, valueF, shape))
```

How are the payoffs for each stimulus computed?

% all(:,4) <- shape value
% all(:,5) <- orientation value
% all(:,6) <- filling color value

round(((all(:,4) + all(:,5) + all(:,6))/2)*100)

```{r}
dat %>%
  select(valueO, valueF, valueS, possiblePayoff) %>%
  mutate(guess = round(100 * ((valueS + valueO + valueF)/2) ))
```

How many times have a subject seen each stim before the first scan? 80 = 8 runs with 10 times for each HT stim in each run

```{r}
tmp = data_yn_clean %>%
  filter(day %in% c(1,2)) %>%
  mutate(stimNumType = ifelse(type == 0, 0, stimNum)) %>%
  select(subnum, day, stimNum, stimNumType) 

with(tmp, table(subnum, stimNumType))
```

Based on your HT stimuli what can you infer/learn about the RE?

```{r}
tmp = data_yn_clean %>%
  filter(subnum == "601")
```

What HT stimuli and payoffs has this subject seen before the first scan?

```{r}
tmp %>%
  select(subnum, day, type, possiblePayoff, stimNum, valueO, valueF, valueS, orientation, filling, shape) %>%
  filter((type == 1) & (day %in% c(1, 2))) %>%
  mutate(mean_payoff = round(100 * ((valueS + valueO + valueF)/2) ),
         stimString = paste0("O: ", orientation, ", F: ", filling, ", S: ", shape)) %>%
  ggplot(aes(possiblePayoff))+
  geom_density()+
  geom_vline(aes(xintercept = 0), color="gray")+
  facet_wrap(~stimString)+
  theme(panel.grid = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())+
  labs(y = "")

```

What do these HT stims look like?

```{r}
ht_features = tmp %>%
  filter(type == 1) %>%
  select(filling, orientation, shape) %>%
  distinct()

imgs = c()
length(imgs)

for(i in 1:nrow(ht_features)){
  
  if(length(imgs) == 0){
    imgs = make_stim_img(shape = ht_features$shape[i], orientation = ht_features$orientation[i], filling = ht_features$filling[i])
  } else{
    imgs = c(imgs, make_stim_img(shape = ht_features$shape[i], orientation = ht_features$orientation[i], filling = ht_features$filling[i])) 
    }
  
}

image_append(imgs)
```

```{r}
shape = 4
orientation = 120
filling = -0.6
```

```{r}
blank = image_blank(width = 800, height = 800, color = "none")

# Needs to be run in terminal or all at one in the chunk
img = image_draw(blank)

bg_hex = convertFVToHEX(filling)

symbols(400, 400, circles = 200, bg = bg_hex, inches = FALSE, add = TRUE, lwd = 6)

bg_circle = image_read(image_write(img))

  
shape_img = image_read(paste0('/Users/zeynepenkavi/Downloads/alldata/data_task/pilot5_fmri_1/task_scan/shapes/shape', shape, '.png'))

tilted_nofill_img = shape_img %>% 
  image_background("none") %>%
  image_scale("200") %>%
  image_rotate(orientation)

tilted_nofill_img = image_read(image_write(tilted_nofill_img))

offset_x = 200 + (200 - (image_info(tilted_nofill_img)$width/2))
offset_y = 200 + (200 - (image_info(tilted_nofill_img)$height/2))
inset_offset = paste0('+', offset_x, '+', offset_y)
image_composite(bg_circle,  tilted_nofill_img, operator = "Over", offset = inset_offset)


```

```{r}
for(i in c(0, 15, 30, 45, 60, 75, 90, 105, 120, 135, 150)){
  shape_img = image_read(paste0('/Users/zeynepenkavi/Downloads/alldata/data_task/pilot5_fmri_1/task_scan/shapes/shape', 2, '.png'))
  
  shape_img2 = image_rotate(shape_img, i)
  
  print(image_info(shape_img2))
}
```


```{r}
tmp = make_stim_img(shape = 3, orientation = 0, filling = -0.6)
```

```{r}
tmp %>%
  tabyl(shape, valueS)
```

```{r}
tmp %>%
  tabyl(filling, valueF)
```

```{r}
tmp %>%
  tabyl(orientation, valueO)
```

When is the filling value .4 worth .4 versus .6? Is it for some value of shape or orientation? Doesn't seem so.

```{r}
tmp %>% 
  filter(filling == .4) %>%
  tabyl(filling, shape, valueF)
```

```{r}
tmp %>% 
  filter(filling == .4) %>%
  tabyl(filling, orientation, valueF)
```


```{r}
img <- image_draw(blank)
rect(20, 20, 200, 100, border = "red", lty = "dashed", lwd = 5)
abline(h = 300, col = 'blue', lwd = '10', lty = "dotted")
text(30, 250, "Hoiven-Glaven", family = "monospace", cex = 4, srt = 90)
palette(rainbow(11, end = 0.9))
symbols(rep(200, 11), seq(0, 400, 40), circles = runif(11, 5, 35),
  bg = 1:11, inches = FALSE, add = TRUE)
```

