---
title: "Novel vs. repeated choice project: DDM posterior predictive checks and simulations for tradeoffs"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: 'hide'
---

# Set up environment and load in data

```{r include=FALSE}
library(tidyverse)
library(here)
library(brms)
library(gridExtra)
theme_set(theme_bw())
helpers_path = paste0(here(),'/analysis/helpers/')
fig_out_path = paste0(here(), '/outputs/fig/')
```

Add columns that will be used for plots below.

```{r}
source(paste0(helpers_path, '01_clean_behavioral_data.R'))

data_yn_clean = data_yn_clean %>%
  mutate(correct = ifelse(possiblePayoff>reference & yesChosen == 1, 1, ifelse(possiblePayoff < reference & yesChosen == 0, 1, 0))) %>%
  mutate(type = ifelse(type == 1, "HT", "RE"),
         week = ifelse(week == 1, "Week 1", ifelse(week == 2, "Week 2", ifelse(week == 3, "Week 3", NA))),
         week = factor(week, levels = c("Week 1", "Week 2", "Week 3"))) %>%
  mutate(val_diff = possiblePayoff - reference,
         val_diff_bin = round(val_diff/50),
         val_diff_bin_str = paste0(val_diff_bin*50-25,":",val_diff_bin*50+25),
         val_diff_bin_str = factor(val_diff_bin_str, levels = c("-225:-175", "-175:-125", "-125:-75", "-75:-25", "-25:25", "25:75", "75:125", "125:175", "175:225")))

data_bc_clean = data_bc_clean %>%
  mutate(correct = ifelse(possiblePayoffleft>possiblePayoffright & leftChosen == 1, 1, ifelse(possiblePayoffleft<possiblePayoffright & leftChosen == 0, 1, 0))) %>%
  mutate(type = ifelse(typeLeft == 1, "HT", "RE"),
         week = ifelse(week == 1, "Week 1", ifelse(week == 2, "Week 2", ifelse(week == 3, "Week 3", NA))),
         week = factor(week, levels = c("Week 1", "Week 2", "Week 3"))) %>%
  mutate(val_diff = possiblePayoffleft - possiblePayoffright,
         val_diff_bin = round(val_diff/50),
         val_diff_bin_str = paste0(val_diff_bin*50-25,":",val_diff_bin*50+25),
         val_diff_bin_str = factor(val_diff_bin_str, levels = c("-275:-225","-225:-175", "-175:-125", "-125:-75", "-75:-25", "-25:25", "25:75", "75:125", "125:175", "175:225", "225:275"))) %>%
  filter(!is.na(val_diff_bin_str))
```

# YN Task

Read in parameter estimates

```{r eval = FALSE}
fn = file.path(here(), "inputs",'yn_hddm_mcmc_draws.csv')

if(file.exists(fn)){
  all_results_df = read.csv(fn)

} else{
  stim_types = c("HT", "RE")
  days = as.character(seq(1,11,1))
  
  in_path = file.path(here(), "inputs")
  
  all_results_df = data.frame()
  
  for(i in 1:length(stim_types)) {
    for(j in 1:length(days)) {
      
      cur_stim_type = stim_types[i]
      cur_day = days[j]
      
      fn = file.path(in_path, paste0('results_YN_HDDM_FIT_', cur_stim_type,'_day_', cur_day,'.RData'))
      
      if(file.exists(fn)) {
        
        load(fn)
        
        cur_results_df = data.frame()
        for(k in 1:length(results$mcmc)){
          cur_chain = as.data.frame(results$mcmc[[k]])
          cur_results_df = rbind(cur_results_df, cur_chain)
        }
        
        cur_results_df = cur_results_df %>%
          gather(par, estimate) %>%
          filter(grepl("\\[", par)) %>%
          mutate(type = cur_stim_type,
                 day = cur_day)
        
        cur_results_df = cur_results_df %>%
          separate(par, c("a", "b"), sep = '\\.', remove = F, fill = "right") %>%
          separate(a, c("c", "d"), sep = "\\[", remove = F, fill = "right") %>%
          select(-a) %>%
          mutate(d = paste0('p[',d)) %>%
          mutate(b = ifelse(is.na(b), d, b)) %>%
          select(-d, -par) %>%
          rename(par_name = c, subnum = b) %>%
          mutate(par_name = ifelse(par_name == "theta", "ndt", ifelse(par_name == "b", "d", ifelse(par_name == "alpha", "sigma", par_name))),
                 subnum = ifelse(subnum == 'p[1]', "601", ifelse(subnum == "p[2]", "609", ifelse(subnum == 'p[3]', "611", ifelse(subnum == "p[4]", "619", ifelse(subnum == "p[5]", "621", ifelse(subnum == "p[6]", "629", subnum)))))),
                 day = as.numeric(day))
        
        all_results_df = rbind(all_results_df, cur_results_df)
        
      } else {
        next
      }
    }
  }
  fn = file.path(here(), "inputs",'yn_hddm_mcmc_draws.csv')
  write.csv(all_results_df, fn, row.names = F)
  rm(cur_chain, cur_results_df, results, cur_day, cur_stim_type, days, fn, i, j, k, stim_types)
}



```

### Correlations between estimates

```{r}
all_d_sigma = all_results_df %>%
  filter(par_name %in% c("d", "sigma"))

rm(all_results_df)
```

```{r}
subs = c('601', '609', '611', '619', '621', '629')
types = c('HT', 'RE')
days = seq(1,11,1)

d_sigma_cors =  data.frame(subnum = NA, type = NA, day = NA, cor = NA)

for (i in 1:length(subs)){
  for (j in 1:length(types)){
    for (k in 1:length(days)){
     
      cur_sub = subs[i]
      cur_type = types[j]
      cur_day = days[k]
      
      cur_ds = all_d_sigma %>%
        filter(subnum == cur_sub & type == cur_type & day == cur_day & par_name == "d") %>%
        select(estimate)
      
      cur_sigmas = all_d_sigma %>%
        filter(subnum == cur_sub & type == cur_type & day == cur_day & par_name == "sigma") %>%
        select(estimate)
      
      cur_cor = round(cor(cur_ds, cur_sigmas), 3)
      
      cur_row = data.frame(subnum = cur_sub, type = cur_type, day = cur_day, cor = as.numeric(cur_cor))
        
      d_sigma_cors = rbind(d_sigma_cors, cur_row)
    }
  }
}


d_sigma_cors = d_sigma_cors %>%
  drop_na()
```

```{r}
p = d_sigma_cors %>%
  ggplot(aes(type, cor, fill=type))+
  geom_boxplot()+
  theme(panel.grid = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(margin = margin(t = 5)),
        legend.box.margin=margin(t = -10))+
  scale_fill_brewer(palette = "Dark2")+
  labs(x = "", fill = "", y = "Correlation between d and sigma estimates")

# ggsave(file=paste0(fig_out_path, 'yn_ddm_d_sigma_cor.jpg'), p, height = 5, width = 5, units="in")
```

## RT by response

```{r}
p = data_yn_clean %>%
  filter(rt < 3) %>%
  select(subnum, day, type, yesChosen, rt) %>%
  mutate(rt = ifelse(yesChosen == 0, rt*(-1), rt),
         day = paste0("Day ", day),
         day = factor(day, levels = paste0("Day ", seq(1,11, 1)))) %>%
  ggplot(aes(rt, fill = type))+
  geom_density(position = "identity", alpha = .5, color = NA)+
  facet_grid(subnum ~ day)+
  theme(panel.grid = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(margin = margin(t = 5)),
        legend.box.margin=margin(t = -10))+
  geom_vline(aes(xintercept = 0), color = "gray") +
  scale_fill_brewer(palette = "Dark2")+
  labs(y = "", fill = "")

p
# ggsave(file=paste0(fig_out_path, 'yn_ddm_raw_rt_dists.jpg'), p, height = 10, width = 18, units="in")
```

### Posterior predictive RTs

For each participant
for each day
for each stim type
n times:
sample the parameters
generate posterior predictive data for all the stimuli of that participant


The `rwiener` function fixes the sd of the diffusion process to 1. Wabersich and Vandekerckhove (2014) explain how to change this:
```
Conversion to a scale with the variance parameter fixed at any s can be done by multiplying the α and δ parameters by 
```

```{r}
cur_sub = 601
cur_type = 'HT'
cur_day = 1

cur_stims = data_yn_clean %>%
  filter(subnum == cur_sub & day == cur_day & type == cur_type) %>%
  select(possiblePayoff, reference, yesChosen, rt)

cur_cond_pars = all_results_df %>%
  filter(subnum == cur_sub & day == cur_day & type == cur_type)


# N times
sampled_pars = cur_cond_pars %>%
  group_by(par_name, type, day) %>%
  sample_n(1)

sampled_sigma = as.numeric(sampled_pars[sampled_pars$par_name == "sigma", 'estimate'])
sampled_d = as.numeric(sampled_pars[sampled_pars$par_name == "d", 'estimate'])
sampled_ndt = as.numeric(sampled_pars[sampled_pars$par_name == "ndt", 'estimate'])
sampled_bias = as.numeric(sampled_pars[sampled_pars$par_name == "bias", 'estimate'])


# Simulate each trial

sim_subj_data = function(cur_stims, sampled_sigma, sampled_d, sampled_ndt, sampled_bias){
  
  pred_data = cur_stims
  pred_data$sampled_sigma = sampled_sigma
  pred_data$sampled_d = sampled_d
  pred_data$sampled_ndt = sampled_ndt
  pred_data$sampled_bias = sampled_bias
  pred_data$pred_rt = NA
  pred_data$pred_yesChosen = NA
  
  for(i in 1:nrow(cur_stims)){
    
    trial_vdiff = cur_stims$possiblePayoff[i] - cur_stims$reference[i]
    cur_pred = sim_trial(trial_vdiff, sampled_sigma, sampled_d, sampled_ndt, sampled_bias)
    
    pred_data$pred_rt[i] = cur_pred$q
    pred_data$pred_yesChosen[i] = cur_pred$resp
    
  }
  
  return(pred_data)
}

sim_trial = function(trial_vdiff, sampled_sigma, sampled_d, sampled_ndt, sampled_bias){
  
  trial_drift = sampled_sigma * (sampled_d * trial_vdiff)
  
  cur_pred = rwiener(1, 2*sampled_sigma, sampled_ndt, sampled_bias, trial_drift)
  
  return(cur_pred)
  
}


```

```{r}
sim_subj_data(cur_stims, sampled_sigma, sampled_d, sampled_ndt, sampled_bias)
```

# Changes in DDM pars

**[THIS ISN'T THE BEST APPROACH. TRY MODELING EACH SUBJECT HIERARCHICALLY INSTEAD]**

### Drift rate

```{r}
fn_draws = paste0(helpers_path, '/inputs/yn_ddm_dRegressions_draws.csv')

if(file.exists(fn_draws)){
  yn_rt_draws = read.csv(fn_draws)
} else{
  subnums = unique(data_yn_clean$subnum)
  
  yn_ddm_draws = data_frame()
  
  for(i in 1:length(subnums)){
    cur_sub = subnums[i]
    
    cur_par_data = all_results_df %>% 
      filter(subnum == cur_sub & par_name == "d")
    
    # REDUCE AMOUNT OF DATA! 100 datapoints per bin
    cur_par_data = cur_par_data %>%
      group_by(type, day) %>%
      sample_n(100)
    
    cur_m <- brm(formula = estimate ~ day * type,
                     data= cur_par_data,
                     warmup = 500,
                     iter = 2500,
                     chains = 4,
                     init = "0",
                     cores = 4,
                     seed = 389253)
    
    cur_draws = as_draws_df(cur_m)
    cur_draws$subnum = cur_sub
    
    yn_ddm_draws = rbind(yn_ddm_draws, cur_draws)
    
  }
  names(yn_ddm_draws) = gsub(":", ".", names(yn_ddm_draws))
  write.csv(yn_ddm_draws, fn_draws, row.names = F)
  
  rm(cur_par_data, cur_m, cur_draws)
}

```

```{r}
yn_par_summary = as.data.frame(yn_ddm_draws) %>%
  select("b_day" ,"b_typeRE", "b_day.typeRE", subnum) %>%
  gather(key, value, -subnum) %>%
  mutate(key = ifelse(key == "b_day", "Day", ifelse(key == "b_typeRE", "Type (RE)", ifelse(key == "b_day.typeRE", "Day * Type (RE)", NA))),
         key = factor(key, levels = c("Type (RE)", "Day", "Day * Type (RE)"))) %>%
  group_by(subnum, key) %>%
  summarise(.groups = 'keep',
            m = mean(value),
            l95 = HDInterval::hdi(value)[1],
            h95 = HDInterval::hdi(value)[2]) %>%
  mutate(subnum = as.factor(subnum),
         task = "Y/N") 
```

```{r}
plim = max(abs(yn_par_summary$l95), yn_par_summary$h95)

p = yn_par_summary %>%
  ggplot(aes(m, subnum)) +
  geom_vline(aes(xintercept = 0), color = "light gray") + 
  geom_point(position = position_dodge(width=.75))+
  geom_errorbarh(aes(xmin = l95, xmax = h95, height=.2), position = position_dodge(width=.75))+
  facet_grid(.~key) +
  labs(x = "Parameter Estimate", y = "Subject", color = "", title = "95% HDI for posterior slopes - d ~ Day * Type") +
  theme(legend.position = "bottom",
        panel.grid = element_blank(),
        legend.box.margin=margin(t = -10))+
  scale_x_continuous(breaks = c(0), limits = c(-plim, plim))

p
# ggsave(file=paste0(fig_out_path, 'yn_ddmD_parEsts.jpg'), p, height = 3, width = 7, units="in")

```

### Sigma

```{r}
fn_draws = paste0(helpers_path, '/inputs/yn_ddm_sigmaRegressions_draws.csv')

if(file.exists(fn_draws)){
  yn_rt_draws = read.csv(fn_draws)
} else{
  subnums = unique(data_yn_clean$subnum)
  
  yn_ddm_draws = data_frame()
  
  for(i in 1:length(subnums)){
    cur_sub = subnums[i]
    
    cur_par_data = all_results_df %>% 
      filter(subnum == cur_sub & par_name == "sigma")
    
    # REDUCE AMOUNT OF DATA! 100 datapoints per bin
    cur_par_data = cur_par_data %>%
      group_by(type, day) %>%
      sample_n(100)
    
    cur_m <- brm(formula = estimate ~ day * type,
                     data= cur_par_data,
                     warmup = 500,
                     iter = 2500,
                     chains = 4,
                     init = "0",
                     cores = 4,
                     seed = 389253)
    
    cur_draws = as_draws_df(cur_m)
    cur_draws$subnum = cur_sub
    
    yn_ddm_draws = rbind(yn_ddm_draws, cur_draws)
    
  }
  names(yn_ddm_draws) = gsub(":", ".", names(yn_ddm_draws))
  write.csv(yn_ddm_draws, fn_draws, row.names = F)
  
  rm(cur_par_data, cur_m, cur_draws)
}

```

```{r}
yn_par_summary = as.data.frame(yn_ddm_draws) %>%
  select("b_day" ,"b_typeRE", "b_day.typeRE", subnum) %>%
  gather(key, value, -subnum) %>%
  mutate(key = ifelse(key == "b_day", "Day", ifelse(key == "b_typeRE", "Type (RE)", ifelse(key == "b_day.typeRE", "Day * Type (RE)", NA))),
         key = factor(key, levels = c("Type (RE)", "Day", "Day * Type (RE)"))) %>%
  group_by(subnum, key) %>%
  summarise(.groups = 'keep',
            m = mean(value),
            l95 = HDInterval::hdi(value)[1],
            h95 = HDInterval::hdi(value)[2]) %>%
  mutate(subnum = as.factor(subnum),
         task = "Y/N") 
```

```{r}
plim = max(abs(yn_par_summary$l95), yn_par_summary$h95)

p = yn_par_summary %>%
  ggplot(aes(m, subnum)) +
  geom_vline(aes(xintercept = 0), color = "light gray") + 
  geom_point(position = position_dodge(width=.75))+
  geom_errorbarh(aes(xmin = l95, xmax = h95, height=.2), position = position_dodge(width=.75))+
  facet_grid(.~key) +
  labs(x = "Parameter Estimate", y = "Subject", color = "", title = "95% HDI for posterior slopes - sigma ~ Day * Type") +
  theme(legend.position = "bottom",
        panel.grid = element_blank(),
        legend.box.margin=margin(t = -10))+
  scale_x_continuous(breaks = c(0), limits = c(-plim, plim))

p
# ggsave(file=paste0(fig_out_path, 'yn_ddmSigma_parEsts.jpg'), p, height = 3, width = 7, units="in")

```

### Bias

```{r}
fn_draws = paste0(helpers_path, '/inputs/yn_ddm_biasRegressions_draws.csv')

if(file.exists(fn_draws)){
  yn_rt_draws = read.csv(fn_draws)
} else{
  subnums = unique(data_yn_clean$subnum)
  
  yn_ddm_draws = data_frame()
  
  for(i in 1:length(subnums)){
    cur_sub = subnums[i]
    
    cur_par_data = all_results_df %>% 
      filter(subnum == cur_sub & par_name == "bias")
    
    # REDUCE AMOUNT OF DATA! 100 datapoints per bin
    cur_par_data = cur_par_data %>%
      group_by(type, day) %>%
      sample_n(100)
    
    cur_m <- brm(formula = estimate ~ day * type,
                     data= cur_par_data,
                     warmup = 500,
                     iter = 2500,
                     chains = 4,
                     init = "0",
                     cores = 4,
                     seed = 389253)
    
    cur_draws = as_draws_df(cur_m)
    cur_draws$subnum = cur_sub
    
    yn_ddm_draws = rbind(yn_ddm_draws, cur_draws)
    
  }
  names(yn_ddm_draws) = gsub(":", ".", names(yn_ddm_draws))
  write.csv(yn_ddm_draws, fn_draws, row.names = F)
  
  rm(cur_par_data, cur_m, cur_draws)
}

```

```{r}
yn_par_summary = as.data.frame(yn_ddm_draws) %>%
  select("b_day" ,"b_typeRE", "b_day.typeRE", subnum) %>%
  gather(key, value, -subnum) %>%
  mutate(key = ifelse(key == "b_day", "Day", ifelse(key == "b_typeRE", "Type (RE)", ifelse(key == "b_day.typeRE", "Day * Type (RE)", NA))),
         key = factor(key, levels = c("Type (RE)", "Day", "Day * Type (RE)"))) %>%
  group_by(subnum, key) %>%
  summarise(.groups = 'keep',
            m = mean(value),
            l95 = HDInterval::hdi(value)[1],
            h95 = HDInterval::hdi(value)[2]) %>%
  mutate(subnum = as.factor(subnum),
         task = "Y/N") 
```

```{r}
plim = max(abs(yn_par_summary$l95), yn_par_summary$h95)

p = yn_par_summary %>%
  ggplot(aes(m, subnum)) +
  geom_vline(aes(xintercept = 0), color = "light gray") + 
  geom_point(position = position_dodge(width=.75))+
  geom_errorbarh(aes(xmin = l95, xmax = h95, height=.2), position = position_dodge(width=.75))+
  facet_grid(.~key) +
  labs(x = "Parameter Estimate", y = "Subject", color = "", title = "95% HDI for posterior slopes - bias ~ Day * Type") +
  theme(legend.position = "bottom",
        panel.grid = element_blank(),
        legend.box.margin=margin(t = -10))+
  scale_x_continuous(breaks = c(0), limits = c(-plim, plim))

p
# ggsave(file=paste0(fig_out_path, 'yn_ddmBias_parEsts.jpg'), p, height = 3, width = 7, units="in")

```

### NDT

```{r}
fn_draws = paste0(helpers_path, '/inputs/yn_ddm_ndtRegressions_draws.csv')

if(file.exists(fn_draws)){
  yn_rt_draws = read.csv(fn_draws)
} else{
  subnums = unique(data_yn_clean$subnum)
  
  yn_ddm_draws = data_frame()
  
  for(i in 1:length(subnums)){
    cur_sub = subnums[i]
    
    cur_par_data = all_results_df %>% 
      filter(subnum == cur_sub & par_name == "ndt")
    
    # REDUCE AMOUNT OF DATA! 100 datapoints per bin
    cur_par_data = cur_par_data %>%
      group_by(type, day) %>%
      sample_n(100)
    
    cur_m <- brm(formula = estimate ~ day * type,
                     data= cur_par_data,
                     warmup = 500,
                     iter = 2500,
                     chains = 4,
                     init = "0",
                     cores = 4,
                     seed = 389253)
    
    cur_draws = as_draws_df(cur_m)
    cur_draws$subnum = cur_sub
    
    yn_ddm_draws = rbind(yn_ddm_draws, cur_draws)
    
  }
  names(yn_ddm_draws) = gsub(":", ".", names(yn_ddm_draws))
  write.csv(yn_ddm_draws, fn_draws, row.names = F)
  
  rm(cur_par_data, cur_m, cur_draws)
}

```

```{r}
yn_par_summary = as.data.frame(yn_ddm_draws) %>%
  select("b_day" ,"b_typeRE", "b_day.typeRE", subnum) %>%
  gather(key, value, -subnum) %>%
  mutate(key = ifelse(key == "b_day", "Day", ifelse(key == "b_typeRE", "Type (RE)", ifelse(key == "b_day.typeRE", "Day * Type (RE)", NA))),
         key = factor(key, levels = c("Type (RE)", "Day", "Day * Type (RE)"))) %>%
  group_by(subnum, key) %>%
  summarise(.groups = 'keep',
            m = mean(value),
            l95 = HDInterval::hdi(value)[1],
            h95 = HDInterval::hdi(value)[2]) %>%
  mutate(subnum = as.factor(subnum),
         task = "Y/N") 
```

```{r}
plim = max(abs(yn_par_summary$l95), yn_par_summary$h95)

p = yn_par_summary %>%
  ggplot(aes(m, subnum)) +
  geom_vline(aes(xintercept = 0), color = "light gray") + 
  geom_point(position = position_dodge(width=.75))+
  geom_errorbarh(aes(xmin = l95, xmax = h95, height=.2), position = position_dodge(width=.75))+
  facet_grid(.~key) +
  labs(x = "Parameter Estimate", y = "Subject", color = "", title = "95% HDI for posterior slopes - ndt ~ Day * Type") +
  theme(legend.position = "bottom",
        panel.grid = element_blank(),
        legend.box.margin=margin(t = -10))+
  scale_x_continuous(breaks = c(0), limits = c(-plim, plim))

p
# ggsave(file=paste0(fig_out_path, 'yn_ddmNDT_parEsts.jpg'), p, height = 3, width = 7, units="in")

```

